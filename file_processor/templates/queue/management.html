{% extends "file_processor/base.html" %}

{% block title %}Queue Management{% endblock %}

{% block extra_css %}
<!-- Custom styles replaced with Tailwind CSS classes -->
{% endblock %}

{% block content %}
<div x-data="queueManagement()" x-init="init()" class="px-4 mt-4">

    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center">
            <h1 class="text-2xl font-bold"><i class="fas fa-tasks mr-2"></i>Queue Management</h1>
            <div class="flex gap-2 ml-4">
                {% if queue_stats.manager.is_running %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <i class="fas fa-play mr-1"></i>
                    Running
                </span>
                {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                    <i class="fas fa-stop mr-1"></i>
                    Stopped
                </span>
                {% endif %}
                {% if queue_stats.manager.is_paused %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                    <i class="fas fa-pause mr-1"></i>
                    Paused
                </span>
                {% endif %}
            </div>
        </div>
        
        <!-- Queue Control Buttons -->
        <form method="post" class="inline-flex flex-wrap gap-2">
            {% csrf_token %}
            {% if not queue_stats.manager.is_running %}
            <button type="submit" name="action" value="start" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-play mr-1"></i>Start Queue
            </button>
            {% else %}
            <button type="submit" name="action" value="stop" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                <i class="fas fa-stop mr-1"></i>Stop Queue
            </button>
            {% if not queue_stats.manager.is_paused %}
            <button type="submit" name="action" value="pause" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                <i class="fas fa-pause mr-1"></i>Pause
            </button>
            {% else %}
            <button type="submit" name="action" value="resume" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-play mr-1"></i>Resume
            </button>
            {% endif %}
            {% endif %}
        </form>
    </div>






    <!-- Task List -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 mx-4">
        <div class="px-6 py-4 border-b border-gray-200">
            <h5 class="text-lg font-semibold"><i class="fas fa-list mr-2"></i>Task List</h5>
        </div>
        <div class="p-6">
            <!-- Filters -->
            <form method="get" class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select name="task_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Types</option>
                            {% for task_type in task_types %}
                            <option value="{{ task_type.task_type }}" {% if task_type_filter == task_type.task_type %}selected{% endif %}>
                                {{ task_type.task_type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">All Statuses</option>
                            {% for status_value, status_label in status_choices %}
                            <option value="{{ status_value }}" {% if status_filter == status_value %}selected{% endif %}>
                                {{ status_label }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Created From</label>
                        <input type="date" name="created_from" value="{{ created_from_filter }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Created To</label>
                        <input type="date" name="created_to" value="{{ created_to_filter }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex items-end">
                        <button type="submit" class="w-full inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-filter mr-2"></i>Filter
                        </button>
                    </div>
                </div>
            </form>

            <!-- Batch Operations -->
            <div class="mb-4">
                <!-- Batch Selection Info -->
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        <span x-show="selectedTasks.length === 0">No tasks selected</span>
                        <span x-show="selectedTasks.length > 0" x-text="`${selectedTasks.length} task(s) selected`"></span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="deleteSelectedTasks()" 
                                x-bind:disabled="selectedTasks.length === 0"
                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-trash mr-2"></i>Delete Selected Tasks
                        </button>
                        <button @click="cancelSelectedTasks()" 
                                x-bind:disabled="selectedTasks.length === 0"
                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-times mr-2"></i>Cancel Selected Tasks
                        </button>
                        <button @click="retrySelectedTasks()" 
                                x-bind:disabled="selectedTasks.length === 0"
                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-redo mr-2"></i>Retry Selected Tasks
                        </button>
                        <button @click="clearSelection()" 
                                x-show="selectedTasks.length > 0"
                                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-times mr-2"></i>Clear Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Task Table -->
            {% if tasks %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                                <input type="checkbox" 
                                       x-model="selectAll" 
                                       @change="toggleSelectAll()"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Retry Count</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed At</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message</th>

                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for task in tasks %}
                        <tr x-data="{ taskStatus: '{{ task.status }}', taskId: {{ task.id }} }">
                            <td class="px-6 py-4 whitespace-nowrap">

                                <input type="checkbox" 
                                       :value="{{ task.id }}"
                                       x-model="selectedTasks"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded task-checkbox">

                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ task.id }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button @click="openTaskDetail({{ task.id }})" 
                                        class="text-sm text-blue-600 hover:text-blue-800 hover:underline text-left">
                                    {{ task.task_name|truncatechars:40 }}
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">{{ task.task_type }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if task.status == 'pending' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>
                                {% elif task.status == 'processing' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-cyan-100 text-cyan-800">Processing</span>
                                {% elif task.status == 'retrying' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Retrying</span>
                                {% elif task.status == 'completed' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Completed</span>
                                {% elif task.status == 'failed' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Failed</span>
                                {% elif task.status == 'cancelled' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-900 text-white">Cancelled</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ task.retry_count }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ task.user.username|default:"System" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ task.created_at|date:"Y-m-d H:i" }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{% if task.started_at %}{{ task.started_at|date:"Y-m-d H:i" }}{% else %}<span class="text-gray-400">-</span>{% endif %}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{% if task.completed_at %}{{ task.completed_at|date:"Y-m-d H:i" }}{% else %}<span class="text-gray-400">-</span>{% endif %}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {% if task.started_at and task.completed_at %}
                                {% with duration=task.completed_at|timeuntil:task.started_at %}
                                <span class="text-gray-600">{{ duration }}</span>
                                {% endwith %}
                                {% else %}
                                <span class="text-gray-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" id="message-{{ task.id }}">
                                <!-- Message will be displayed here -->
                            </td>

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if paginator.num_pages > 1 %}
            <div class="mt-6 flex items-center justify-between">
                <div class="text-sm text-gray-700">
                    Showing 
                    <span class="font-medium">{{ tasks.start_index }}</span>
                    to 
                    <span class="font-medium">{{ tasks.end_index }}</span>
                    of 
                    <span class="font-medium">{{ paginator.count }}</span>
                    results
                </div>
                <div class="flex gap-1">
                    {% if tasks.has_previous %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ tasks.previous_page_number }}" 
                           class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Previous
                        </a>
                    {% endif %}
                    
                    {% for num in tasks.paginator.page_range %}
                        {% if tasks.number == num %}
                            <span class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">{{ num }}</span>
                        {% elif num > tasks.number|add:'-3' and num < tasks.number|add:'3' %}
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" 
                               class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if tasks.has_next %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ tasks.next_page_number }}" 
                           class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                            Next
                        </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% else %}
            <p class="text-gray-500">No tasks found</p>
            {% endif %}
        </div>
    </div>

<!-- Task Detail Modal -->
<div x-show="showTaskModal" 
     x-cloak
     class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div @click.away="closeTaskModal()" class="w-full max-w-7xl bg-white rounded-lg p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4 border-b pb-4">
            <h3 class="text-lg font-bold">Task Details</h3>
            <button @click="closeTaskModal()" class="text-gray-500 hover:text-gray-700">
                âœ• Close
            </button>
        </div>
        <div x-show="loadingTask" class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading task details...</p>
        </div>
        <div x-show="!loadingTask && taskDetailHtml" x-html="taskDetailHtml"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>


function queueManagement() {
    return {
        showTaskModal: false,
        loadingTask: false,
        taskDetailHtml: '',
        selectedTasks: [],
        selectAll: false,
        rowMessages: new Map(), // Store messages for each row
        
        init() {
            console.log('queueManagement init called');
            
            // Auto-refresh queue stats every 30 seconds
            setInterval(() => {
                this.refreshQueueStats();
            }, 30000);
            
            // Progress bars functionality removed
            
            // Set up event listeners for modal events
            this.$el.addEventListener('close-modal', () => {
                console.log('close-modal event received');
                this.closeTaskModal();
            });
            

        },
        
        async openTaskDetail(taskId) {
            console.log('openTaskDetail called with taskId:', taskId);
            this.showTaskModal = true;
            this.loadingTask = true;
            this.taskDetailHtml = '';
            
            // Debug: Log state changes
            console.log('After setting state - showTaskModal:', this.showTaskModal, 'loadingTask:', this.loadingTask);
            
            try {
                const url = `/queue/task_detail/${taskId}/`;
                console.log('Fetching URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const html = await response.text();
                    console.log('Response HTML length:', html.length);
                    console.log('First 200 chars:', html.substring(0, 200));
                    this.taskDetailHtml = html;
                } else {
                    console.error('Response not ok:', response.status);
                    this.taskDetailHtml = '<div class="p-8 text-center text-red-600">Failed to load task details. Status: ' + response.status + '</div>';
                }
            } catch (error) {
                console.error('Error loading task detail:', error);
                this.taskDetailHtml = '<div class="p-8 text-center text-red-600">Error loading task details: ' + error.message + '</div>';
            } finally {
                this.loadingTask = false;
                console.log('Request completed - showTaskModal:', this.showTaskModal, 'loadingTask:', this.loadingTask, 'taskDetailHtml length:', this.taskDetailHtml.length);
            }
        },
        
        closeTaskModal() {
            this.showTaskModal = false;
            this.taskDetailHtml = '';
        },
        

        

        
        getCsrfToken() {
            // Get CSRF token from cookie
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        },
        

        
        refreshQueueStats() {
            // Optional: Implement queue stats refresh
            console.log('Refreshing queue stats...');
        },
        

        


        
        getStatusClass(status) {
            const classes = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'processing': 'bg-blue-100 text-blue-800',
                'completed': 'bg-green-100 text-green-800',
                'failed': 'bg-red-100 text-red-800',
                'cancelled': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        },
        
        getStatusIcon(status) {
            const icons = {
                'pending': 'fa-clock',
                'processing': 'fa-spinner fa-spin',
                'completed': 'fa-check-circle',
                'failed': 'fa-exclamation-circle',
                'cancelled': 'fa-times-circle'
            };
            return icons[status] || 'fa-question-circle';
        },
        
        getPriorityClass(priority) {
            const classes = {
                '0': 'bg-gray-100 text-gray-800',
                '1': 'bg-blue-100 text-blue-800',
                '2': 'bg-orange-100 text-orange-800',
                '3': 'bg-red-100 text-red-800'
            };
            return classes[priority] || 'bg-gray-100 text-gray-800';
        },
        
        // Batch selection methods
        toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.task-checkbox');
            if (this.selectAll) {
                this.selectedTasks = Array.from(checkboxes).map(cb => parseInt(cb.value));
            } else {
                this.selectedTasks = [];
            }
        },
        
        clearSelection() {
            this.selectedTasks = [];
            this.selectAll = false;
            const checkboxes = document.querySelectorAll('.task-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
        },
        
        showMessage(taskId, text, type) {
            // Store message in rowMessages Map
            this.rowMessages.set(taskId, {
                text: text,
                type: type,
                timestamp: Date.now()
            });
            
            // Update DOM to show message
            const messageCell = document.getElementById(`message-${taskId}`);
            if (messageCell) {
                let colorClass, iconClass;
                if (type === 'success') {
                    colorClass = 'text-green-600';
                    iconClass = 'fa-check-circle';
                } else if (type === 'error') {
                    colorClass = 'text-red-600';
                    iconClass = 'fa-exclamation-circle';
                } else if (type === 'warning') {
                    colorClass = 'text-yellow-600';
                    iconClass = 'fa-exclamation-triangle';
                } else {
                    colorClass = 'text-gray-600';
                    iconClass = 'fa-info-circle';
                }
                
                messageCell.innerHTML = `
                    <div x-show="true" 
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0"
                         x-transition:enter-end="opacity-100"
                         class="${colorClass} text-xs">
                        <i class="fas mr-1 ${iconClass}"></i>
                        ${text}
                    </div>
                `;
            }
            
            // Auto-hide success messages after 5 seconds, error messages after 10 seconds
            const hideDelay = type === 'success' ? 5000 : 10000;
            setTimeout(() => {
                this.clearRowMessage(taskId);
            }, hideDelay);
        },
        
        clearRowMessage(taskId) {
            // Remove from Map
            this.rowMessages.delete(taskId);
            
            // Clear DOM
            const messageCell = document.getElementById(`message-${taskId}`);
            if (messageCell) {
                messageCell.innerHTML = '';
            }
        },
        
        hideTaskRow(taskId) {
            // Find and remove the table row for the deleted task
            const row = document.querySelector(`tr:has(input[value="${taskId}"])`);
            if (row) {
                row.style.transition = 'opacity 0.3s, transform 0.3s';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    row.remove();
                }, 300);
            }
        },
        
        updateTaskStatus(taskId, newStatus) {
            // Find and update the status cell for the cancelled task
            const row = document.querySelector(`tr:has(input[value="${taskId}"])`);
            if (row) {
                const statusCell = row.querySelector('td:nth-child(5)'); // Status column
                if (statusCell) {
                    // Update status display
                    const statusSpan = statusCell.querySelector('span');
                    if (statusSpan) {
                        if (newStatus === 'cancelled') {
                            statusSpan.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-900 text-white';
                            statusSpan.textContent = 'Cancelled';
                        } else if (newStatus === 'pending') {
                            statusSpan.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
                            statusSpan.textContent = 'Pending';
                        }
                    }
                }
                // Remove checkbox for cancelled task
                if (newStatus === 'cancelled') {
                    const checkboxCell = row.querySelector('td:first-child');
                    if (checkboxCell) {
                        checkboxCell.innerHTML = '<div class="w-4 h-4"></div>';
                    }
                }
            }
        },
        
        async deleteSelectedTasks() {
            if (this.selectedTasks.length === 0) {
                return;
            }
            
            const confirmMessage = `Are you sure you want to delete ${this.selectedTasks.length} selected task(s)?\n\nThis action cannot be undone.`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Define allowed statuses for deletion
            const allowedStatuses = ['completed', 'failed', 'cancelled'];
            
            for (const taskId of this.selectedTasks) {
                try {
                    // Get task status from the DOM
                    const taskRow = document.querySelector(`tr:has(input[value="${taskId}"])`);
                    if (!taskRow) {
                        this.showMessage(taskId, 'Task not found', 'error');
                        continue;
                    }
                    
                    const taskStatus = taskRow._x_dataStack?.[0]?.taskStatus;
                    
                    // Frontend validation
                    if (!allowedStatuses.includes(taskStatus)) {
                        this.showMessage(taskId, `Cannot delete task in status: ${taskStatus}`, 'warning');
                        continue;
                    }
                    
                    // Backend request
                    const response = await fetch('/queue/delete-task/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken(),
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            task_id: taskId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Remove task from selected list and hide row
                        this.selectedTasks = this.selectedTasks.filter(id => id !== taskId);
                        this.hideTaskRow(taskId);
                    } else {
                        // Show error message in the row's Message column
                        this.showMessage(taskId, `Failed: ${data.message}`, 'error');
                    }
                } catch (error) {
                    // Show error message in the row's Message column
                    this.showMessage(taskId, `Error: ${error.message}`, 'error');
                }
            }
            
            this.selectAll = false;
        },
        
        async cancelSelectedTasks() {
            if (this.selectedTasks.length === 0) {
                return;
            }
            
            const confirmMessage = `Are you sure you want to cancel ${this.selectedTasks.length} selected task(s)?\\n\\nThis action cannot be undone.`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Define allowed statuses for cancellation
            const allowedStatuses = ['pending', 'processing', 'retrying'];
            
            for (const taskId of this.selectedTasks) {
                try {
                    // Get task status from the DOM
                    const taskRow = document.querySelector(`tr:has(input[value="${taskId}"])`);
                    if (!taskRow) {
                        this.showMessage(taskId, 'Task not found', 'error');
                        continue;
                    }
                    
                    const taskStatus = taskRow._x_dataStack?.[0]?.taskStatus;
                    
                    // Frontend validation
                    if (!allowedStatuses.includes(taskStatus)) {
                        this.showMessage(taskId, `Cannot cancel task in status: ${taskStatus}`, 'warning');
                        continue;
                    }
                    
                    // Backend request
                    const response = await fetch(`/queue/task_detail/${taskId}/cancel/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken(),
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Remove task from selected list
                        this.selectedTasks = this.selectedTasks.filter(id => id !== taskId);
                        this.updateTaskStatus(taskId, 'cancelled');
                        // Show success message in the row's Message column
                        this.showMessage(taskId, 'Cancelled successfully', 'success');
                    } else {
                        // Show error message in the row's Message column
                        this.showMessage(taskId, `Failed: ${data.message}`, 'error');
                    }
                } catch (error) {
                    // Show error message in the row's Message column
                    this.showMessage(taskId, `Error: ${error.message}`, 'error');
                }
            }
            
            this.selectAll = false;
        },
        
        async retrySelectedTasks() {
            if (this.selectedTasks.length === 0) {
                return;
            }
            
            const confirmMessage = `Are you sure you want to retry ${this.selectedTasks.length} selected task(s)?`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Define allowed statuses for retry
            const allowedStatuses = ['failed', 'completed', 'cancelled'];
            
            for (const taskId of this.selectedTasks) {
                try {
                    // Get task status from the DOM
                    const taskRow = document.querySelector(`tr:has(input[value="${taskId}"])`);
                    if (!taskRow) {
                        this.showMessage(taskId, 'Task not found', 'error');
                        continue;
                    }
                    
                    const taskStatus = taskRow._x_dataStack?.[0]?.taskStatus;
                    
                    // Frontend validation
                    if (!allowedStatuses.includes(taskStatus)) {
                        this.showMessage(taskId, `Cannot retry task in status: ${taskStatus}`, 'warning');
                        continue;
                    }
                    
                    // Backend request
                    const response = await fetch(`/queue/task_detail/${taskId}/retry/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken(),
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Remove task from selected list
                        this.selectedTasks = this.selectedTasks.filter(id => id !== taskId);
                        this.updateTaskStatus(taskId, 'pending');
                        // Show success message in the row's Message column
                        this.showMessage(taskId, 'Retry queued successfully', 'success');
                    } else {
                        // Show error message in the row's Message column
                        this.showMessage(taskId, `Failed: ${data.message}`, 'error');
                    }
                } catch (error) {
                    // Show error message in the row's Message column
                    this.showMessage(taskId, `Error: ${error.message}`, 'error');
                }
            }
            
            this.selectAll = false;
        },
    }
}
</script>
{% endblock %}